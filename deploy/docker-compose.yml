# NGO60 一鍵部署
# 使用方式：
#   curl -O https://raw.githubusercontent.com/KaelLim/ngo-60/main/deploy/docker-compose.yml
#   docker compose up -d

services:
  db:
    image: postgres:18
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_NAME:-events_app}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  init-db:
    image: postgres:18
    depends_on:
      db:
        condition: service_healthy
    environment:
      PGHOST: db
      PGUSER: ${DB_USER:-postgres}
      PGPASSWORD: ${DB_PASSWORD:-postgres}
      PGDATABASE: ${DB_NAME:-events_app}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        apt-get update && apt-get install -y curl
        curl -fsSL https://raw.githubusercontent.com/KaelLim/ngo-60/main/db/init.sql | psql
    restart: "no"

  api:
    image: denoland/deno:latest
    depends_on:
      db:
        condition: service_healthy
      init-db:
        condition: service_completed_successfully
    environment:
      DB_HOST: db
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_NAME: ${DB_NAME:-events_app}
    volumes:
      - uploads_data:/app/api/uploads
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        apt-get update && apt-get install -y git
        git clone https://github.com/KaelLim/ngo-60.git /app
        cd /app/api
        mkdir -p uploads/gallery
        deno run --allow-net --allow-env --allow-read --allow-write --allow-run main.ts
    restart: unless-stopped

  web:
    image: denoland/deno:latest
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        apt-get update && apt-get install -y git
        git clone https://github.com/KaelLim/ngo-60.git /app
        cd /app/web
        deno install --node-modules-dir --entrypoint npm:vite
        deno run -A --node-modules-dir npm:vite build
        echo "Build complete"
    volumes:
      - web_dist:/app/web/dist
    restart: "no"

  nginx:
    image: nginx:alpine
    depends_on:
      - api
      - web
    ports:
      - "${PORT:-80}:80"
    volumes:
      - web_dist:/usr/share/nginx/html:ro
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        # 等待前端建置完成
        while [ ! -f /usr/share/nginx/html/index.html ]; do
          echo "Waiting for web build..."
          sleep 5
        done

        # 安裝 htpasswd
        apk add --no-cache apache2-utils curl

        # 下載 nginx 設定
        curl -fsSL https://raw.githubusercontent.com/KaelLim/ngo-60/main/nginx/nginx.conf -o /etc/nginx/conf.d/default.conf

        # 設定登入帳密
        htpasswd -bc /etc/nginx/.htpasswd ${ADMIN_USER:-admin} ${ADMIN_PASSWORD:-changeme}

        # 啟動 nginx
        nginx -g 'daemon off;'
    restart: unless-stopped

volumes:
  postgres_data:
  uploads_data:
  web_dist:
