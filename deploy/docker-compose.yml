# NGO60 一鍵部署
# 使用方式：
#   curl -O https://raw.githubusercontent.com/KaelLim/ngo-60/main/deploy/docker-compose.yml
#   docker compose up -d

services:
  db:
    image: postgres:18
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_NAME:-events_app}
    volumes:
      - postgres_data:/var/lib/postgresql
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  init-db:
    image: ubuntu:24.04
    depends_on:
      db:
        condition: service_healthy
    environment:
      PGPASSWORD: ${DB_PASSWORD:-postgres}
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        apt-get update && apt-get install -y postgresql-client curl
        curl -fsSL https://raw.githubusercontent.com/KaelLim/ngo-60/main/db/init.sql | psql -h db -U postgres -d ${DB_NAME:-events_app}
    restart: "no"

  api:
    image: ubuntu:24.04
    depends_on:
      db:
        condition: service_healthy
      init-db:
        condition: service_completed_successfully
    environment:
      DB_HOST: db
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_NAME: ${DB_NAME:-events_app}
      DENO_INSTALL: /root/.deno
      PATH: /root/.deno/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    volumes:
      - uploads_data:/uploads
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        apt-get update && apt-get install -y curl git unzip

        # 安裝 Deno
        if [ ! -f /root/.deno/bin/deno ]; then
          curl -fsSL https://deno.land/install.sh | sh
        fi

        # Clone 專案
        if [ ! -f /app/api/main.ts ]; then
          rm -rf /app
          git clone https://github.com/KaelLim/ngo-60.git /app
        fi

        cd /app/api
        # 連結 uploads 目錄
        rm -rf uploads
        ln -sf /uploads uploads
        mkdir -p /uploads/gallery

        /root/.deno/bin/deno run --allow-net --allow-env --allow-read --allow-write --allow-run main.ts
    restart: unless-stopped

  web:
    image: ubuntu:24.04
    environment:
      DENO_INSTALL: /root/.deno
      PATH: /root/.deno/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    volumes:
      - web_dist:/dist
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        if [ -f /dist/index.html ]; then
          echo "Build already exists, skipping"
          exit 0
        fi

        apt-get update && apt-get install -y curl git unzip

        # 安裝 Deno
        curl -fsSL https://deno.land/install.sh | sh

        # Clone 並建置
        git clone https://github.com/KaelLim/ngo-60.git /tmp/ngo60
        cd /tmp/ngo60/web
        /root/.deno/bin/deno install --node-modules-dir --entrypoint npm:vite
        /root/.deno/bin/deno run -A --node-modules-dir npm:vite build
        cp -r dist/* /dist/
        echo "Build complete"
    restart: "no"

  nginx:
    image: nginx:alpine
    depends_on:
      - api
      - web
    ports:
      - "${PORT:-80}:80"
    volumes:
      - web_dist:/usr/share/nginx/html:ro
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        # 安裝 htpasswd 工具
        apk add --no-cache apache2-utils curl

        # 等待前端建置完成
        while [ ! -f /usr/share/nginx/html/index.html ]; do
          echo "Waiting for web build..."
          sleep 5
        done

        # 下載 nginx 設定
        curl -fsSL https://raw.githubusercontent.com/KaelLim/ngo-60/main/nginx/nginx.conf -o /etc/nginx/conf.d/default.conf

        # 設定登入帳密
        htpasswd -bc /etc/nginx/.htpasswd ${ADMIN_USER:-admin} ${ADMIN_PASSWORD:-changeme}

        # 啟動 nginx
        nginx -g 'daemon off;'
    restart: unless-stopped

volumes:
  postgres_data:
  uploads_data:
  web_dist:
