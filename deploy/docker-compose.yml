# NGO60 簡化部署
# 使用方式：
#   curl -O https://raw.githubusercontent.com/KaelLim/ngo-60/main/deploy/docker-compose.yml
#   docker compose up -d

services:
  db:
    image: postgres:18
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_NAME:-events_app}
    volumes:
      - postgres_data:/var/lib/postgresql
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  app:
    image: ubuntu:24.04
    depends_on:
      db:
        condition: service_healthy
    environment:
      DB_HOST: db
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_NAME: ${DB_NAME:-events_app}
      ADMIN_USER: ${ADMIN_USER:-admin}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-changeme}
    ports:
      - "${PORT:-80}:80"
    volumes:
      - uploads_data:/uploads
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        export DEBIAN_FRONTEND=noninteractive

        echo "=== [1/6] 安裝系統套件 ==="
        apt-get update
        apt-get install -y --no-install-recommends \
          curl git unzip nginx apache2-utils postgresql-client ca-certificates

        echo "=== [2/6] 初始化資料庫 ==="
        export PGPASSWORD=${DB_PASSWORD:-postgres}
        curl -fsSL https://raw.githubusercontent.com/KaelLim/ngo-60/main/db/init.sql | \
          psql -h db -U ${DB_USER:-postgres} -d ${DB_NAME:-events_app}

        echo "=== [3/6] 安裝 Deno ==="
        if [ ! -f /root/.deno/bin/deno ]; then
          curl -fsSL https://deno.land/install.sh | sh
        fi
        DENO=/root/.deno/bin/deno
        # 建立 symlink 讓 Deno.Command 可以找到 deno
        ln -sf /root/.deno/bin/deno /usr/local/bin/deno

        echo "=== [4/6] Clone 專案並建置前端 ==="
        if [ -d /app/.git ]; then
          echo "專案已存在，更新中..."
          cd /app && git pull
        else
          rm -rf /app
          git clone https://github.com/KaelLim/ngo-60.git /app
        fi
        cd /app/web
        $$DENO install --node-modules-dir --entrypoint npm:vite
        $$DENO run -A --node-modules-dir npm:vite build

        echo "=== [5/6] 設定 Nginx ==="
        cp /app/nginx/nginx.conf /etc/nginx/sites-available/default
        # 因為 API 和 Nginx 在同一容器，將 api:8000 改為 localhost:8000
        sed -i 's/api:8000/localhost:8000/g' /etc/nginx/sites-available/default
        cp -r /app/web/dist/* /usr/share/nginx/html/
        htpasswd -bc /etc/nginx/.htpasswd ${ADMIN_USER:-admin} ${ADMIN_PASSWORD:-changeme}

        # 連結 uploads 目錄 (持久化儲存)
        mkdir -p /uploads/gallery
        rm -rf /app/api/uploads
        ln -sf /uploads /app/api/uploads

        # 複製預設圖片 (如果 gallery 是空的)
        if [ -z "$(ls -A /uploads/gallery 2>/dev/null)" ]; then
          echo "複製預設圖片..."
          cp /app/seed/gallery/* /uploads/gallery/ 2>/dev/null || true
        fi

        echo "=== [6/6] 啟動服務 ==="
        # 啟動 Nginx (背景)
        nginx

        # 啟動 Deno API (前景)
        cd /app/api
        exec $$DENO run --allow-net --allow-env --allow-read --allow-write --allow-run main.ts
    restart: unless-stopped

volumes:
  postgres_data:
  uploads_data:
