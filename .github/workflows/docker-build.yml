  # GitHub Actions: 自動建置並推送 Docker images                                                                                                                                                                                                                               
  # 觸發條件：                                                                                                                                                                                                                                                                 
  #   - Push 到 main branch                                                                                                                                                                                                                                                    
  #   - 建立 tag (v*)                                                                                                                                                                                                                                                          
  #   - 手動觸發                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                               
  name: Build and Push Docker Images                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                               
  on:                                                                                                                                                                                                                                                                          
    push:                                                                                                                                                                                                                                                                      
      branches:                                                                                                                                                                                                                                                                
        - main                                                                                                                                                                                                                                                                 
      tags:                                                                                                                                                                                                                                                                    
        - 'v*'                                                                                                                                                                                                                                                                 
    workflow_dispatch:                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                               
  env:                                                                                                                                                                                                                                                                         
    DOCKER_USERNAME: kaellim                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                               
  jobs:                                                                                                                                                                                                                                                                        
    build-and-push:                                                                                                                                                                                                                                                            
      runs-on: ubuntu-latest                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                               
      steps:                                                                                                                                                                                                                                                                   
        - name: Checkout code                                                                                                                                                                                                                                                  
          uses: actions/checkout@v4                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                               
        - name: Set up Docker Buildx                                                                                                                                                                                                                                           
          uses: docker/setup-buildx-action@v3                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                               
        - name: Login to Docker Hub                                                                                                                                                                                                                                            
          uses: docker/login-action@v3                                                                                                                                                                                                                                         
          with:                                                                                                                                                                                                                                                                
            username: ${{ env.DOCKER_USERNAME }}                                                                                                                                                                                                                               
            password: ${{ secrets.DOCKERHUB_TOKEN }}                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                               
        - name: Extract metadata for API                                                                                                                                                                                                                                       
          id: meta-api                                                                                                                                                                                                                                                         
          uses: docker/metadata-action@v5                                                                                                                                                                                                                                      
          with:                                                                                                                                                                                                                                                                
            images: ${{ env.DOCKER_USERNAME }}/ngo60-api                                                                                                                                                                                                                       
            tags: |                                                                                                                                                                                                                                                            
              type=ref,event=branch                                                                                                                                                                                                                                            
              type=semver,pattern={{version}}                                                                                                                                                                                                                                  
              type=semver,pattern={{major}}.{{minor}}                                                                                                                                                                                                                          
              type=raw,value=latest,enable={{is_default_branch}}                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                               
        - name: Extract metadata for Nginx                                                                                                                                                                                                                                     
          id: meta-nginx                                                                                                                                                                                                                                                       
          uses: docker/metadata-action@v5                                                                                                                                                                                                                                      
          with:                                                                                                                                                                                                                                                                
            images: ${{ env.DOCKER_USERNAME }}/ngo60-nginx                                                                                                                                                                                                                     
            tags: |                                                                                                                                                                                                                                                            
              type=ref,event=branch                                                                                                                                                                                                                                            
              type=semver,pattern={{version}}                                                                                                                                                                                                                                  
              type=semver,pattern={{major}}.{{minor}}                                                                                                                                                                                                                          
              type=raw,value=latest,enable={{is_default_branch}}                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                               
        - name: Build and push API image                                                                                                                                                                                                                                       
          uses: docker/build-push-action@v5                                                                                                                                                                                                                                    
          with:                                                                                                                                                                                                                                                                
            context: ./api                                                                                                                                                                                                                                                     
            file: ./api/Dockerfile                                                                                                                                                                                                                                             
            push: true                                                                                                                                                                                                                                                         
            tags: ${{ steps.meta-api.outputs.tags }}                                                                                                                                                                                                                           
            labels: ${{ steps.meta-api.outputs.labels }}                                                                                                                                                                                                                       
            cache-from: type=gha                                                                                                                                                                                                                                               
            cache-to: type=gha,mode=max                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                               
        - name: Build and push Nginx image                                                                                                                                                                                                                                     
          uses: docker/build-push-action@v5                                                                                                                                                                                                                                    
          with:                                                                                                                                                                                                                                                                
            context: .                                                                                                                                                                                                                                                         
            file: ./nginx/Dockerfile.full                                                                                                                                                                                                                                      
            push: true                                                                                                                                                                                                                                                         
            tags: ${{ steps.meta-nginx.outputs.tags }}                                                                                                                                                                                                                         
            labels: ${{ steps.meta-nginx.outputs.labels }}                                                                                                                                                                                                                     
            cache-from: type=gha                                                                                                                                                                                                                                               
            cache-to: type=gha,mode=max                                                                                                                                                                                                                                        
            build-args: |                                                                                                                                                                                                                                                      
              ADMIN_USER=admin                                                                                                                                                                                                                                                 
              ADMIN_PASSWORD=changeme                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                               
        - name: Summary                                                                                                                                                                                                                                                        
          run: |                                                                                                                                                                                                                                                               
            echo "## Docker Images Built" >> $GITHUB_STEP_SUMMARY                                                                                                                                                                                                              
            echo "" >> $GITHUB_STEP_SUMMARY                                                                                                                                                                                                                                    
            echo "### API Image" >> $GITHUB_STEP_SUMMARY                                                                                                                                                                                                                       
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY                                                                                                                                                                                                                              
            echo "${{ steps.meta-api.outputs.tags }}" >> $GITHUB_STEP_SUMMARY                                                                                                                                                                                                  
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY                                                                                                                                                                                                                              
            echo "" >> $GITHUB_STEP_SUMMARY                                                                                                                                                                                                                                    
            echo "### Nginx Image" >> $GITHUB_STEP_SUMMARY                                                                                                                                                                                                                     
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY                                                                                                                                                                                                                              
            echo "${{ steps.meta-nginx.outputs.tags }}" >> $GITHUB_STEP_SUMMARY                                                                                                                                                                                                
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY  
